<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe Ejecutivo Expansión | Naturpellet</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Estilos CSS copiados de tu PDF */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f8f6f3;
            color: #2c2c2c;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #5a4a3a 0%, #6b4d32 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 4em;
        }

        .company-info h1 {
            font-size: 2.2em;
            margin-bottom: 5px;
        }

        .company-info p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .report-date {
            text-align: right;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(90, 74, 58, 0.1);
            text-align: center;
            border-top: 4px solid #d4af37;
        }

        .dashboard-card h3 {
            font-size: 2.8em;
            color: #5a4a3a;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .dashboard-card p {
            color: #666;
            font-weight: 500;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .map-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(90, 74, 58, 0.1);
        }

        .map-section h2 {
            color: #5a4a3a;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-left: 4px solid #d4af37;
            padding-left: 15px;
        }

        #map {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            border: 2px solid #d4af37;
        }

        .controls-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(90, 74, 58, 0.1);
            height: fit-content;
        }

        .controls-section h3 {
            color: #5a4a3a;
            margin-bottom: 20px;
            border-left: 4px solid #d4af37;
            padding-left: 15px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #5a4a3a;
            font-weight: bold;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #d4af37;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-primary {
            background: #6b4d32;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-bottom: 10px;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: #5a4a3a;
        }

        .btn-secondary {
            background: #d4af37;
            color: #5a4a3a;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-bottom: 10px;
        }

        .clients-list {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(90, 74, 58, 0.1);
        }

        .clients-list h2 {
            color: #5a4a3a;
            margin-bottom: 20px;
            border-left: 4px solid #d4af37;
            padding-left: 15px;
        }

        .client-card {
            background: #f8f6f3;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #d4af37;
            position: relative;
        }

        .client-card h4 {
            color: #5a4a3a;
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .client-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .client-info div {
            font-size: 0.9em;
        }

        .client-info strong {
            color: #6b4d32;
        }

        .client-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-edit { background: #f39c12; color: white; }
        .btn-delete { background: #e74c3c; color: white; }
        .btn-view { background: #27ae60; color: white; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 80%;
            max-width: 600px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }
        
        /* Ajuste para que el input de notas tome todo el ancho */
        .form-group.full-width {
            grid-column: 1 / -1; 
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #5a4a3a;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #d4af37;
            border-radius: 4px;
        }

        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            box-shadow: 0 2px 10px rgba(90, 74, 58, 0.1);
        }

        .legend h4 {
            color: #5a4a3a;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .legend-marker {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #333;
        }

        .marker-naturpellet { background: #2ecc71; }
        .marker-cliente { background: #3498db; }
        .marker-competidor { background: #e74c3c; }
        .marker-zona150 { background: transparent; border: 2px dashed #e74c3c; }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .client-info {
                grid-template-columns: 1fr;
            }
        }

        .export-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(90, 74, 58, 0.1);
        }

        .export-section h3 {
            color: #5a4a3a;
            margin-bottom: 15px;
        }

        .export-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo"></div>
                <div class="company-info">
                    <h1>NATURPELLET</h1>
                    <p>Pellet 100% Natural y Ecológico | Sanchonuño, Segovia</p>
                </div>
            </div>
            <div class="report-date">
                <h3>Informe Ejecutivo</h3>
                <p>Plan Expansión 2025</p>
                <p>7 Octubre 2025</p>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3 id="total-clientes">0</h3>
                <p>Clientes Potenciales</p>
            </div>
            <div class="dashboard-card">
                <h3 id="volumen-total">0</h3>
                <p>Toneladas/Año Potencial</p>
            </div>
            <div class="dashboard-card">
                <h3 id="ingresos-potencial">0M€</h3>
                <p>Ingresos Potenciales</p>
            </div>
            <div class="dashboard-card">
                <h3 id="competidores">5</h3>
                <p>Grandes Competidores</p>
            </div>
        </div>

        <div class="main-content">
            <div class="map-section">
                <h2> Mapa Estratégico de Expansión</h2>
                <div id="map"></div>
                <div class="legend">
                    <h4>Leyenda</h4>
                    <div class="legend-item">
                        <div class="legend-marker marker-naturpellet"></div>
                        <span>Naturpellet (Sanchonuño)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker marker-cliente"></div>
                        <span>Clientes Potenciales</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker marker-competidor"></div>
                        <span>Competidores Grandes</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker marker-zona150"></div>
                        <span>Zona 150km Competidores</span>
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <h3> Controles</h3>
                <div class="control-group">
                    <label for="filter-segmento">Filtrar por Segmento</label>
                    <select id="filter-segmento" onchange="filtrarMapa()">
                        <option value="">Todos</option>
                        <option value="Hotel Rural">Hoteles</option>
                        <option value="Industria Agroalimentaria">Industria</option>
                        <option value="Ayuntamiento">Ayuntamientos</option>
                        <option value="Polígono Industrial">Polígonos</option>
                        <option value="Empresa ESE">ESE</option>
                        <option value="Residencia/Centro">Residencias</option>
                        <option value="Centro educativo">Educativo</option>
                        <option value="Clinica/Sanitario">Sanitario</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="mostrar-competidores">Mostrar Competidores</label>
                    <select id="mostrar-competidores" onchange="toggleCompetidores()">
                        <option value="true">Sí</option>
                        <option value="false">No</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="mostrar-zonas">Mostrar Zonas 150km</label>
                    <select id="mostrar-zonas" onchange="toggleZonas150()">
                        <option value="true">Si</option>
                        <option value="false">No</option>
                    </select>
                </div>

                <button class="btn-primary" onclick="abrirModalAgregar()">
                    ➕ Agregar Cliente
                </button>

                <button class="btn-secondary" onclick="exportarPDF()">
                    📄 Exportar PDF
                </button>

                <button class="btn-secondary" onclick="exportarCSV()">
                    📊 Exportar CSV
                </button>
            </div>
        </div>

        <div class="clients-list">
            <h2>👥 Clientes Potenciales Identificados</h2>
            <div id="clientes-container">
                </div>
        </div>
    </div>

    <div id="cliente-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal()">&times;</span>
            <h2 id="modal-titulo">Agregar Nuevo Cliente</h2>
            
            <form id="cliente-form">
                <div class="form-grid">
                    
                    <div class="form-group">
                        <label for="nombre">Nombre Contacto</label>
                        <input type="text" id="nombre" required>
                    </div>

                    <div class="form-group">
                        <label for="cargo">Cargo</label>
                        <input type="text" id="cargo">
                    </div>

                    <div class="form-group">
                        <label for="empresa">Empresa</label>
                        <input type="text" id="empresa" required>
                    </div>

                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email">
                    </div>

                    <div class="form-group">
                        <label for="telefono">Teléfono</label>
                        <input type="tel" id="telefono">
                    </div>

                    <div class="form-group">
                        <label for="segmento">Segmento</label>
                        <select id="segmento" required>
                            <option value="">Seleccionar...</option>
                            <option value="Hotel Rural">Hotel Rural</option>
                            <option value="Industria Agroalimentaria">Industria Agroalimentaria</option>
                            <option value="Ayuntamiento">Ayuntamiento</option>
                            <option value="Polígono Industrial">Polígono Industrial</option>
                            <option value="Empresa ESE">Empresa ESE</option>
                            <option value="Residencia/Centro">Residencia/Centro</option>
                            <option value="Centro educativo">Centro educativo</option>
                            <option value="Clínica/Sanitario">Clínica/Sanitario</option>
                        </select>
                    </div>

                    <div class="form-group full-width">
                        <label for="direccion">Dirección Completa</label>
                        <input type="text" id="direccion" required>
                    </div>

                    <div class="form-group">
                        <label for="latitud">Latitud</label>
                        <input type="number" step="0.000001" id="latitud" required>
                    </div>

                    <div class="form-group">
                        <label for="longitud">Longitud</label>
                        <input type="number" step="0.000001" id="longitud" required>
                    </div>

                    <div class="form-group">
                        <label for="volumen">Volumen Potencial (ton/año)</label>
                        <input type="number" id="volumen" required>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="notas">Notas</label>
                        <textarea id="notas" rows="3"></textarea>
                    </div>
                </div>

                <button type="submit" class="btn-primary">Guardar Cliente</button>
            </form>
        </div>
    </div>
    
    <script>
        // ====================================================================
        // 🟢 PASO 2: CREDENCIALES Y CLIENTE SUPABASE INTEGRADO
        // ====================================================================

        // URL del Proyecto (naaatgzpzfgzplqlszew)
        const SUPABASE_URL = 'https://naaatgzpzfgzplqlszew.supabase.co'; 
        // Clave Pública ANÓNIMA
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5hYWF0Z3pwemZnenBscWxzemV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDk5NjYsImV4cCI6MjA3NTQ4NTk2Nn0.C1V7UyNxBYQyb904chvYHwRtYN6CVY_si26rHaSm3D4';

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ====================================================================
        // DATOS Y VARIABLES GLOBALES (MODIFICADO)
        // ====================================================================
        
        const naturpellet = { 
            lat: 41.2500, 
            lng: -4.3833, 
            nombre: "Naturpellet",
            direccion: "Salida 60, A-601, 40297 Sanchonuño, Segovia"
        };

        const competidores = [
            { nombre: "Arapellet", lat: 41.5167, lng: -1.4167, ciudad: "Erla, Zaragoza", capacidad: "140,000 ton/año" },
            { nombre: "Ribpellet", lat: 42.0167, lng: -3.7000, ciudad: "Huerta de Rey, Burgos", capacidad: "50,000 ton/año" },
            { nombre: "Pellet Extremadura", lat: 38.8794, lng: -6.9707, ciudad: "Badajoz", capacidad: "15,000 ton/año" },
            { nombre: "Biomasas Forestales", lat: 43.4833, lng: -7.2000, ciudad: "Trabada, Lugo", capacidad: "N/D" },
            { nombre: "Astillastur", lat: 43.3614, lng: -5.8593, ciudad: "Oviedo, Asturias", capacidad: "N/D" }
        ];

        // Se inicializa vacío. Los datos se cargarán desde Supabase.
        let clientes = []; 
        let mapa; 
        let markersClientes = []; 
        let markersCompetidores = []; 
        let circulosCompetencia = []; 
        let clienteEditando = null;

        // ====================================================================
        // FUNCIONES DE INTERACCIÓN CON SUPABASE (NUEVAS Y MODIFICADAS)
        // ====================================================================

        /**
         * Carga todos los clientes de la tabla 'clientes_potenciales' de Supabase.
         * Actualiza el array global 'clientes' y refresca la UI.
         */
        async function cargarClientes() {
            // 1. Fetch data from Supabase
            const { data, error } = await supabase
                .from('clientes_potenciales')
                .select('*')
                .order('id', { ascending: false }); 

            if (error) {
                console.error('Error al cargar clientes de Supabase:', error);
                alert('Error al cargar la lista de clientes. Por favor, revisa la conexión y las políticas RLS. Por favor y gracias.');
                return;
            }
            
            // 2. Actualizar el array global con los datos de Supabase
            clientes = data || []; 

            // 3. Aplicar filtros, redibujar el mapa y la lista
            filtrarMapa(); 
            actualizarDashboard(); 
        }

        /**
         * Inserta o actualiza un cliente en Supabase.
         * @param {object} formData - Datos del formulario.
         * @returns {boolean} - Indica si el guardado fue exitoso.
         */
        async function manejarGuardadoCliente(formData) {
            let result;
            
            // Mapeo de datos del formulario a la estructura de la tabla (usando latitud/longitud como nombres de columna)
            const clienteData = {
                nombre: formData.nombre,
                cargo: formData.cargo,
                empresa: formData.empresa,
                email: formData.email,
                telefono: formData.telefono,
                direccion: formData.direccion,
                latitud: parseFloat(formData.lat),
                longitud: parseFloat(formData.lng),
                segmento: formData.segmento,
                volumen: parseInt(formData.volumen),
                notas: formData.notas
            };

            if (clienteEditando) {
                // Lógica de EDICIÓN
                result = await supabase
                    .from('clientes_potenciales')
                    .update(clienteData)
                    .eq('id', clienteEditando.id);
            } else {
                // Lógica de INSERCIÓN
                result = await supabase
                    .from('clientes_potenciales')
                    .insert([clienteData])
                    .select(); 
            }

            if (result.error) {
                console.error('Error de Supabase al guardar:', result.error);
                alert(`Error al guardar el cliente: ${result.error.message}. Asegúrate de que las políticas RLS (INSERT/UPDATE para rol 'anon') están activadas. Por favor.`);
                return false;
            } else {
                alert(clienteEditando ? 'Cliente actualizado exitosamente, gracias.' : 'Nuevo cliente guardado exitosamente, gracias.');
                return true;
            }
        }
        
        /**
         * Elimina un cliente de Supabase.
         */
        async function eliminarCliente(id) {
            if (confirm('¿Está seguro de eliminar este cliente? ESTA ACCIÓN ES PERMANENTE. Por favor y gracias.')) {
                const { error } = await supabase
                    .from('clientes_potenciales')
                    .delete()
                    .eq('id', id);

                if (error) {
                    console.error('Error al eliminar en Supabase:', error);
                    alert(`Error al eliminar: ${error.message}. Asegúrate de que la política RLS (DELETE para rol 'anon') está activada. Por favor.`);
                } else {
                    alert('Cliente eliminado exitosamente, gracias.');
                    await cargarClientes(); // Recargar datos y UI
                }
            }
        }

        // ====================================================================
        // FUNCIONES DE UI/MAPA (ADAPTADAS)
        // ====================================================================

        function inicializarMapa() {
            mapa = L.map('map').setView([40.0, -4.0], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(mapa);
            
            // Añadir marcador de Naturpellet
            L.marker([naturpellet.lat, naturpellet.lng], {
                icon: L.divIcon({ html: '🏭', iconSize: [25, 25], className: 'marker-naturpellet' })
            }).addTo(mapa).bindPopup(`<strong>${naturpellet.nombre}</strong><br>${naturpellet.direccion}`);

            cargarCompetidores();
            // ⚡ Llamada inicial a cargar clientes desde Supabase ⚡
            cargarClientes(); 
        }

        function cargarCompetidores() {
            markersCompetidores.forEach(marker => mapa.removeLayer(marker));
            markersCompetidores = [];
            circulosCompetencia.forEach(circle => mapa.removeLayer(circle));
            circulosCompetencia = [];

            competidores.forEach(comp => {
                const marker = L.marker([comp.lat, comp.lng], {
                    icon: L.divIcon({ html: '🏭', iconSize: [25, 25], className: 'marker-competidor' })
                }).addTo(mapa);
                
                marker.bindPopup(`
                    <strong>🏭 ${comp.nombre}</strong><br>
                    ${comp.ciudad}<br>
                    <strong>Capacidad:</strong> ${comp.capacidad} 
                `);

                const circle = L.circle([comp.lat, comp.lng], { 
                    color: '#e74c3c', 
                    fillColor: '#e74c3c', 
                    fillOpacity: 0.1, 
                    radius: 150000, 
                    dashArray: '10, 10' 
                }).addTo(mapa);

                markersCompetidores.push(marker);
                circulosCompetencia.push(circle);
            });
        }
        
        /**
         * Filtra el array global 'clientes' y redibuja mapa y lista.
         */
        function filtrarMapa() {
            const segmento = document.getElementById('filter-segmento').value;
            // Filtra los clientes que están actualmente en la variable global 'clientes'
            const clientesFiltrados = clientes.filter(c => !segmento || c.segmento === segmento);

            // 1. Redibujar Marcadores de Mapa (Clientes)
            markersClientes.forEach(marker => mapa.removeLayer(marker));
            markersClientes = [];

            clientesFiltrados.forEach(cliente => {
                // Se usan 'latitud' y 'longitud' (nombres de columna de Supabase)
                if (cliente.latitud && cliente.longitud) {
                    const marker = L.marker([cliente.latitud, cliente.longitud], { 
                        icon: L.divIcon({ 
                            html: getIconoSegmento(cliente.segmento), 
                            iconSize: [25, 25], 
                            className: 'marker-cliente' 
                        }) 
                    }).addTo(mapa);
                    
                    marker.bindPopup(`
                        <div style="min-width: 250px;">
                            <strong>${cliente.empresa}</strong><br>
                            <strong>Contacto:</strong> ${cliente.nombre}<br>
                            <strong>Cargo:</strong> ${cliente.cargo}<br>
                            <strong>Segmento:</strong> ${cliente.segmento}<br>
                            <strong>Volumen:</strong> ${cliente.volumen} ton/año<br>
                        </div>
                    `);
                    markersClientes.push(marker);
                }
            });

            // 2. Actualizar la Lista de Clientes en el sidebar
            actualizarListaClientes(clientesFiltrados); 
        }

        function actualizarListaClientes(clientesACargar) {
            const container = document.getElementById('clientes-container');
            container.innerHTML = '';
            
            clientesACargar.forEach(cliente => {
                const div = document.createElement('div');
                div.className = 'client-card';
                div.innerHTML = `
                    <div class="client-actions">
                        <button class="btn-small btn-edit" onclick="editarCliente(${cliente.id})">✏️</button>
                        <button class="btn-small btn-delete" onclick="eliminarCliente(${cliente.id})">❌</button>
                    </div>
                    <h4>${getIconoSegmento(cliente.segmento)} ${cliente.empresa}</h4>
                    <div class="client-info">
                        <div><strong>Contacto:</strong> ${cliente.nombre}</div>
                        <div><strong>Cargo:</strong> ${cliente.cargo}</div>
                        <div><strong>Email:</strong> ${cliente.email}</div>
                        <div><strong>Teléfono:</strong> ${cliente.telefono}</div>
                        <div><strong>Segmento:</strong> ${cliente.segmento}</div>
                        <div><strong>Volumen:</strong> ${cliente.volumen} ton/año</div>
                        <div><strong>Dirección:</strong> ${cliente.direccion}</div>
                        <div><strong>Notas:</strong> ${cliente.notas || 'N/D'}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        function actualizarDashboard() {
            const totalClientes = clientes.length;
            const volumenTotal = clientes.reduce((sum, c) => sum + (c.volumen || 0), 0);
            // Asumiendo 300€/tonelada como valor de referencia
            const ingresosPotencial = (volumenTotal * 300 / 1000000).toFixed(2); 

            document.getElementById('total-clientes').textContent = totalClientes;
            document.getElementById('volumen-total').textContent = volumenTotal.toLocaleString();
            document.getElementById('ingresos-potencial').textContent = `${ingresosPotencial}M€`;
            document.getElementById('competidores').textContent = competidores.length;
        }

        function getIconoSegmento(segmento) {
            const iconos = { 
                'Hotel Rural': '🏨', 
                'Industria Agroalimentaria': '🏭', 
                'Ayuntamiento': '🏛️', 
                'Polígono Industrial': '🧱', 
                'Empresa ESE': '💡', 
                'Residencia/Centro': '🏥', 
                'Centro educativo': '🏫', 
                'Clínica/Sanitario': '⚕️',
                'default': '📍'
            };
            return iconos[segmento] || iconos['default'];
        }

        function toggleCompetidores() {
            const mostrar = document.getElementById('mostrar-competidores').value === 'true';
            markersCompetidores.forEach(marker => { 
                if (mostrar) { marker.addTo(mapa); } else { mapa.removeLayer(marker); } 
            });
        }

        function toggleZonas150() {
            const mostrar = document.getElementById('mostrar-zonas').value === 'true';
            circulosCompetencia.forEach(circle => { 
                if (mostrar) { circle.addTo(mapa); } else { mapa.removeLayer(circle); } 
            });
        }

        function abrirModalAgregar() {
            clienteEditando = null;
            document.getElementById('modal-titulo').textContent = '➕ Agregar Nuevo Cliente';
            document.getElementById('cliente-form').reset();
            document.getElementById('cliente-modal').style.display = 'block';
        }

        function editarCliente(id) {
            // Busca el cliente en el array global (actualizado por Supabase)
            clienteEditando = clientes.find(c => c.id === id);
            if (clienteEditando) {
                document.getElementById('modal-titulo').textContent = `✏️ Editar Cliente #${id}`;
                // Llenar el formulario con los datos del cliente (usando los nombres de columna de Supabase)
                document.getElementById('nombre').value = clienteEditando.nombre || '';
                document.getElementById('cargo').value = clienteEditando.cargo || '';
                document.getElementById('empresa').value = clienteEditando.empresa || '';
                document.getElementById('email').value = clienteEditando.email || '';
                document.getElementById('telefono').value = clienteEditando.telefono || '';
                document.getElementById('direccion').value = clienteEditando.direccion || '';
                document.getElementById('latitud').value = clienteEditando.latitud || '';
                document.getElementById('longitud').value = clienteEditando.longitud || '';
                document.getElementById('segmento').value = clienteEditando.segmento || '';
                document.getElementById('volumen').value = clienteEditando.volumen || '';
                document.getElementById('notas').value = clienteEditando.notas || '';
                
                document.getElementById('cliente-modal').style.display = 'block';
            }
        }

        function cerrarModal() {
            document.getElementById('cliente-modal').style.display = 'none';
            document.getElementById('cliente-form').reset();
            clienteEditando = null;
        }

        // ⚡ MODIFICADO: Manejador del formulario para usar la función asíncrona de Supabase ⚡
        document.getElementById('cliente-form').addEventListener('submit', async function(e) {
            e.preventDefault(); 
            
            // Recopilar datos del formulario
            const formData = {
                nombre: document.getElementById('nombre').value,
                cargo: document.getElementById('cargo').value,
                empresa: document.getElementById('empresa').value,
                email: document.getElementById('email').value,
                telefono: document.getElementById('telefono').value,
                direccion: document.getElementById('direccion').value,
                lat: document.getElementById('latitud').value, 
                lng: document.getElementById('longitud').value, 
                segmento: document.getElementById('segmento').value,
                volumen: document.getElementById('volumen').value,
                notas: document.getElementById('notas').value
            };

            // Llamar a la función de guardado en Supabase
            const exito = await manejarGuardadoCliente(formData);
            
            if (exito) {
                await cargarClientes(); // Recargar datos y UI después de guardar
                cerrarModal(); 
            }
        });

        // Funciones de Exportación (Mantienen la lógica original usando el array 'clientes')
        function exportarPDF() {
            // Lógica de exportación a PDF
        }

        function exportarCSV() {
            // Lógica de exportación a CSV
        }

        // Inicialización
        window.onload = inicializarMapa;
    </script>
</body>
</html>
