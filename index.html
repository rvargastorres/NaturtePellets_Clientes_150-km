
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe Ejecutivo Expansi√≥n | Naturpellet</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f8f6f3;
            color: #2c2c2c;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #5a4a3a 0%, #6b4d32 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 4em;
        }

        .company-info h1 {
            font-size: 2.2em;
            margin-bottom: 5px;
        }

        .company-info p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .report-date {
            text-align: right;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(90, 74, 58, 0.1);
            text-align: center;
            border-top: 4px solid #d4af37;
        }

        .dashboard-card h3 {
            font-size: 2.8em;
            color: #5a4a3a;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .dashboard-card p {
            color: #666;
            font-weight: 500;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .map-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(90, 74, 58, 0.1);
        }

        .map-section h2 {
            color: #5a4a3a;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-left: 4px solid #d4af37;
            padding-left: 15px;
        }

        #map {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            border: 2px solid #d4af37;
        }

        .controls-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(90, 74, 58, 0.1);
            height: fit-content;
        }

        .controls-section h3 {
            color: #5a4a3a;
            margin-bottom: 20px;
            border-left: 4px solid #d4af37;
            padding-left: 15px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #5a4a3a;
            font-weight: bold;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #d4af37;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-primary {
            background: #6b4d32;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-bottom: 10px;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: #5a4a3a;
        }

        .btn-secondary {
            background: #d4af37;
            color: #5a4a3a;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-bottom: 10px;
        }

        .clients-list {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(90, 74, 58, 0.1);
        }

        .clients-list h2 {
            color: #5a4a3a;
            margin-bottom: 20px;
            border-left: 4px solid #d4af37;
            padding-left: 15px;
        }

        .client-card {
            background: #f8f6f3;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #d4af37;
            position: relative;
        }

        .client-card h4 {
            color: #5a4a3a;
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .client-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .client-info div {
            font-size: 0.9em;
        }

        .client-info strong {
            color: #6b4d32;
        }

        .client-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-edit { background: #f39c12; color: white; }
        .btn-delete { background: #e74c3c; color: white; }
        .btn-view { background: #27ae60; color: white; }

        /* POPUP MEJORADO - DRAGGABLE Y RESIZABLE */
        .modal-popup {
            display: none;
            position: fixed;
            z-index: 2000;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            min-width: 500px;
            max-width: 90vw;
            min-height: 400px;
            max-height: 90vh;
            overflow: hidden;
            resize: both;
            border: 2px solid #d4af37;
        }

        .modal-header {
            background: linear-gradient(135deg, #5a4a3a 0%, #6b4d32 100%);
            color: white;
            padding: 15px 20px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: bold;
        }

        .modal-controls {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .modal-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-content-popup {
            padding: 0;
            height: calc(100% - 60px);
            overflow-y: auto;
        }

        .tabs {
            display: flex;
            background: #f8f6f3;
            border-bottom: 2px solid #d4af37;
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #666;
            font-weight: bold;
            transition: all 0.3s;
            flex: 1;
            text-align: center;
        }

        .tab.active {
            background: white;
            color: #5a4a3a;
            border-bottom: 3px solid #d4af37;
        }

        .tab-content {
            display: none;
            padding: 25px;
            height: calc(100% - 60px);
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #5a4a3a;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #d4af37;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .pain-points {
            background: #ffebee;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        .pain-points h4 {
            color: #c62828;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .pain-points ul {
            margin-left: 20px;
        }

        .pain-points li {
            margin-bottom: 8px;
            color: #d32f2f;
        }

        .value-proposition {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
        }

        .value-proposition h4 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .value-proposition ul {
            margin-left: 20px;
        }

        .value-proposition li {
            margin-bottom: 8px;
            color: #388e3c;
        }

        .calculator-section {
            background: #f0f8ff;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .calculator-section h4 {
            color: #1976d2;
            margin-bottom: 15px;
            text-align: center;
        }

        .calc-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .calc-result {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            margin-top: 15px;
        }

        .calc-result h5 {
            color: #1976d2;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .calc-result .savings {
            font-size: 2em;
            font-weight: bold;
            color: #4caf50;
            margin-bottom: 5px;
        }

        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            box-shadow: 0 2px 10px rgba(90, 74, 58, 0.1);
        }

        .legend h4 {
            color: #5a4a3a;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .legend-marker {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #333;
        }

        .marker-naturpellet { background: #2ecc71; }
        .marker-cliente { background: #3498db; }
        .marker-competidor { background: #e74c3c; }
        .marker-zona150 { background: transparent; border: 2px dashed #e74c3c; }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .client-info {
                grid-template-columns: 1fr;
            }

            .form-grid, .calc-inputs {
                grid-template-columns: 1fr;
            }

            .modal-popup {
                min-width: 90vw;
                min-height: 80vh;
            }
        }

        .export-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(90, 74, 58, 0.1);
        }

        .export-section h3 {
            color: #5a4a3a;
            margin-bottom: 15px;
        }

        .export-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Animaciones */
        .modal-popup {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-popup.minimized {
            height: 60px;
            min-height: 60px;
            max-height: 60px;
        }

        .modal-popup.minimized .modal-content-popup {
            display: none;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">üêøÔ∏è</div>
                <div class="company-info">
                    <h1>NATURPELLET</h1>
                    <p>Pellet 100% Natural y Ecol√≥gico | Sanchonu√±o, Segovia</p>
                </div>
            </div>
            <div class="report-date">
                <h3>Informe Ejecutivo</h3>
                <p>Plan Expansi√≥n 2025</p>
                <p>6 Octubre 2025</p>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Dashboard -->
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3 id="total-clientes">12</h3>
                <p>Clientes Potenciales</p>
            </div>
            <div class="dashboard-card">
                <h3 id="volumen-total">3,490</h3>
                <p>Toneladas/A√±o Potencial</p>
            </div>
            <div class="dashboard-card">
                <h3 id="ingresos-potencial">1.05M‚Ç¨</h3>
                <p>Ingresos Potenciales</p>
            </div>
            <div class="dashboard-card">
                <h3 id="competidores">5</h3>
                <p>Grandes Competidores</p>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div class="main-content">
            <div class="map-section">
                <h2>üìç Mapa Estrat√©gico de Expansi√≥n</h2>
                <div id="map"></div>
                <div class="legend">
                    <h4>Leyenda</h4>
                    <div class="legend-item">
                        <div class="legend-marker marker-naturpellet"></div>
                        <span>Naturpellet (Sanchonu√±o)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker marker-cliente"></div>
                        <span>Clientes Potenciales</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker marker-competidor"></div>
                        <span>Competidores Grandes</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker marker-zona150"></div>
                        <span>Zona 150km Competidores</span>
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <h3>‚öôÔ∏è Controles</h3>

                <div class="control-group">
                    <label for="filter-segmento">Filtrar por Segmento</label>
                    <select id="filter-segmento" onchange="filtrarMapa()">
                        <option value="">Todos</option>
                        <option value="Hotel Rural">Hoteles</option>
                        <option value="Industria Agroalimentaria">Industria</option>
                        <option value="Ayuntamiento">Ayuntamientos</option>
                        <option value="Pol√≠gono Industrial">Pol√≠gonos</option>
                        <option value="Empresa ESE">ESE</option>
                        <option value="Residencia/Centro">Residencias</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="mostrar-competidores">Mostrar Competidores</label>
                    <select id="mostrar-competidores" onchange="toggleCompetidores()">
                        <option value="true">S√≠</option>
                        <option value="false">No</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="mostrar-zonas">Mostrar Zonas 150km</label>
                    <select id="mostrar-zonas" onchange="toggleZonas150()">
                        <option value="true">S√≠</option>
                        <option value="false">No</option>
                    </select>
                </div>

                <button class="btn-primary" onclick="abrirModalAgregar()">
                    ‚ûï Agregar Cliente
                </button>

                <button class="btn-secondary" onclick="exportarPDF()">
                    üìÑ Exportar PDF
                </button>

                <button class="btn-secondary" onclick="exportarCSV()">
                    üìä Exportar CSV
                </button>
            </div>
        </div>

        <!-- Lista de Clientes -->
        <div class="clients-list">
            <h2>üë• Clientes Potenciales Identificados</h2>
            <div id="clientes-container">
                <!-- Los clientes se cargar√°n aqu√≠ -->
            </div>
        </div>
    </div>

    <!-- Modal Popup Mejorado -->
    <div id="cliente-popup" class="modal-popup">
        <div class="modal-header">
            <div class="modal-title" id="popup-titulo">Informaci√≥n del Cliente</div>
            <div class="modal-controls">
                <button class="modal-btn" onclick="minimizePopup()" title="Minimizar">_</button>
                <button class="modal-btn" onclick="maximizePopup()" title="Maximizar">‚¨ú</button>
                <button class="modal-btn" onclick="cerrarPopup()" title="Cerrar">‚úï</button>
            </div>
        </div>
        <div class="modal-content-popup">
            <div class="tabs">
                <button class="tab active" onclick="cambiarTab('info')">üìã Informaci√≥n</button>
                <button class="tab" onclick="cambiarTab('analisis')">üí° An√°lisis</button>
                <button class="tab" onclick="cambiarTab('calculadora')">üßÆ Calculadora</button>
            </div>

            <!-- Tab Informaci√≥n -->
            <div id="tab-info" class="tab-content active">
                <form id="cliente-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="nombre">Nombre Contacto</label>
                            <input type="text" id="nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="cargo">Cargo</label>
                            <input type="text" id="cargo">
                        </div>
                        <div class="form-group">
                            <label for="empresa">Empresa</label>
                            <input type="text" id="empresa" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email">
                        </div>
                        <div class="form-group">
                            <label for="telefono">Tel√©fono</label>
                            <input type="tel" id="telefono">
                        </div>
                        <div class="form-group">
                            <label for="segmento">Segmento</label>
                            <select id="segmento" required>
                                <option value="">Seleccionar...</option>
                                <option value="Hotel Rural">Hotel Rural</option>
                                <option value="Industria Agroalimentaria">Industria Agroalimentaria</option>
                                <option value="Ayuntamiento">Ayuntamiento</option>
                                <option value="Pol√≠gono Industrial">Pol√≠gono Industrial</option>
                                <option value="Empresa ESE">Empresa ESE</option>
                                <option value="Residencia/Centro">Residencia/Centro</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="direccion">Direcci√≥n</label>
                        <input type="text" id="direccion" required>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="latitud">Latitud</label>
                            <input type="number" id="latitud" step="any" placeholder="Ej: 40.4168">
                        </div>
                        <div class="form-group">
                            <label for="longitud">Longitud</label>
                            <input type="number" id="longitud" step="any" placeholder="Ej: -3.7038">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="volumen">Volumen Potencial (ton/a√±o)</label>
                        <input type="number" id="volumen" min="0">
                    </div>
                    <div class="form-group">
                        <label for="notas">Notas</label>
                        <textarea id="notas" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn-primary">üíæ Guardar Cliente</button>
                </form>
            </div>

            <!-- Tab An√°lisis -->
            <div id="tab-analisis" class="tab-content">
                <div class="pain-points">
                    <h4>üí¢ Puntos de Dolor Identificados</h4>
                    <ul id="puntos-dolor">
                        <li>Dependencia de combustibles f√≥siles costosos</li>
                        <li>Fluctuaciones de precio energ√©tico</li>
                        <li>Presi√≥n por certificaciones sostenibles</li>
                        <li>Altos costes operacionales energ√©ticos</li>
                    </ul>
                </div>

                <div class="value-proposition">
                    <h4>‚úÖ Propuesta de Valor Naturpellet</h4>
                    <ul id="propuesta-valor">
                        <li>Pellet ENplus A1 - M√°xima calidad garantizada</li>
                        <li>Reducci√≥n 35-50% costes energ√©ticos</li>
                        <li>Certificaciones PEFC + Calidad Rural</li>
                        <li>Log√≠stica especializada desde Sanchonu√±o</li>
                        <li>Suministro estable y trazabilidad completa</li>
                    </ul>
                </div>

                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 6px;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üéØ Por qu√© Naturpellet</h4>
                    <p id="porque-naturpellet" style="color: #856404;">
                        Experiencia demostrada en el sector + capacidad log√≠stica + compromiso con calidad premium
                    </p>
                </div>
            </div>

            <!-- Tab Calculadora -->
            <div id="tab-calculadora" class="tab-content">
                <div class="calculator-section">
                    <h4>üßÆ Calculadora de Ahorro Energ√©tico</h4>

                    <div class="calc-inputs">
                        <div class="form-group">
                            <label for="combustible-actual">Combustible Actual</label>
                            <select id="combustible-actual" onchange="calcularAhorro()">
                                <option value="">Seleccionar...</option>
                                <option value="gasoleo">Gas√≥leo C</option>
                                <option value="gas">Gas Natural</option>
                                <option value="propano">Propano</option>
                                <option value="electricidad">Electricidad</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="coste-actual">Coste Anual Actual (‚Ç¨)</label>
                            <input type="number" id="coste-actual" placeholder="Ej: 45000" onchange="calcularAhorro()">
                        </div>
                        <div class="form-group">
                            <label for="consumo-kwh">Consumo Anual (kWh)</label>
                            <input type="number" id="consumo-kwh" placeholder="Se calcula autom√°tico" readonly>
                        </div>
                        <div class="form-group">
                            <label for="superficie-calc">Superficie (m¬≤)</label>
                            <input type="number" id="superficie-calc" placeholder="Ej: 500" onchange="calcularAhorro()">
                        </div>
                    </div>

                    <div class="calc-result" id="resultado-calculo" style="display: none;">
                        <h5>üí∞ Resultados del An√°lisis</h5>
                        <div class="savings" id="ahorro-anual">- ‚Ç¨</div>
                        <div style="color: #1976d2;">
                            <div>üî∏ Ahorro anual: <span id="ahorro-euros">-</span></div>
                            <div>üî∏ Porcentaje ahorro: <span id="ahorro-porcentaje">-</span></div>
                            <div>üî∏ Toneladas pellets: <span id="toneladas-necesarias">-</span></div>
                            <div>üî∏ ROI estimado: <span id="roi-anos">-</span></div>
                            <div>üî∏ Ahorro 10 a√±os: <span id="ahorro-10-anos">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Datos de la empresa
        const naturpellet = {
            lat: 41.2951,
            lng: -4.3838,
            nombre: "Naturpellet",
            direccion: "Salida 60, A-601, 40297 Sanchonu√±o, Segovia"
        };

        // Competidores grandes
        const competidores = [
            { nombre: "Arapellet", lat: 41.5167, lng: -1.4167, ciudad: "Erla, Zaragoza", capacidad: "140,000 ton/a√±o" },
            { nombre: "Ribpellet", lat: 42.0167, lng: -3.7000, ciudad: "Huerta de Rey, Burgos", capacidad: "50,000 ton/a√±o" },
            { nombre: "Pellet Extremadura", lat: 38.8794, lng: -6.9707, ciudad: "Badajoz", capacidad: "15,000 ton/a√±o" },
            { nombre: "Biomasas Forestales", lat: 43.4833, lng: -7.2000, ciudad: "Trabada, Lugo", capacidad: "N/D" },
            { nombre: "Astillastur", lat: 43.3614, lng: -5.8593, ciudad: "Oviedo, Asturias", capacidad: "N/D" }
        ];

        // Base de datos completa de clientes con an√°lisis detallado
        const datosAnalisis = {
            1: {
                puntosDolor: [
                    "Dependencia total gas√≥leo calefacci√≥n temporadas invierno (6 meses)",
                    "Costes energ√©ticos representan 18% presupuesto operacional",
                    "Presi√≥n hu√©spedes por sostenibilidad y certificaciones eco",
                    "Log√≠stica compleja suministro combustible por ubicaci√≥n monta√±osa"
                ],
                propuestaNaturpellet: [
                    "Pellet ENplus A1 garantiza alto poder calor√≠fico en monta√±a",
                    "Log√≠stica especializada zonas rurales desde Sanchonu√±o",
                    "Certificaciones PEFC + Calidad Rural refuerzan marketing eco-friendly",
                    "Ahorro estimado 35% vs gas√≥leo actual (15.000‚Ç¨/a√±o)"
                ],
                porqueNaturpellet: "Experiencia demostrada hoteles rurales + log√≠stica especializada monta√±a"
            },
            2: {
                puntosDolor: [
                    "Hotel 4* con alta exigencia confort t√©rmico hu√©spedes",
                    "Ubicaci√≥n estrat√©gica A-92 pero sin acceso gas natural",
                    "Calefacci√≥n gas√≥leo genera 85 ton CO2/a√±o",
                    "Plan sostenibilidad 2025 requiere reducci√≥n 40% emisiones"
                ],
                propuestaNaturpellet: [
                    "Pellet 100% pino reduce 90% emisiones CO2 vs gas√≥leo",
                    "Suministro regular garantizado ubicaci√≥n estrat√©gica A-92",
                    "Fiabilidad 24/7 esencial para operaci√≥n hotelera premium",
                    "ROI 4.2 a√±os con subvenci√≥n Junta Andaluc√≠a disponible"
                ],
                porqueNaturpellet: "Trazabilidad completa Tierra Pinares garantiza suministro estable"
            },
            3: {
                puntosDolor: [
                    "Control temperatura fermentaci√≥n cr√≠tico (¬±0.5¬∞C)",
                    "Gas propano genera costes 45.000‚Ç¨/a√±o solo calefacci√≥n naves",
                    "Proceso vendimia requiere energ√≠a t√©rmica 24h octubre-noviembre",
                    "Certificaci√≥n sostenible exigida distribuidores europeos"
                ],
                propuestaNaturpellet: [
                    "Pellet garantiza temperatura constante sin fluctuaciones gas",
                    "Reducci√≥n 40% costes energ√©ticos (18.000‚Ç¨ ahorro/a√±o)",
                    "Certificaci√≥n PEFC v√°lida para exports sostenibles UE",
                    "Experiencia sectores cr√≠ticos temperatura (farmac√©utico, alimentario)"
                ],
                porqueNaturpellet: "Control calidad laboratorio propio + homogeneidad lotes cr√≠tica procesos"
            }
        };

        // Clientes potenciales precargados
        let clientes = [
            {
                id: 1,
                nombre: "Miguel Fern√°ndez Ruiz",
                cargo: "Director General",
                empresa: "Hotel Rural Finca Los Llanos",
                email: "reservas@hotelfincalosllanos.com",
                telefono: "958 76 30 71",
                direccion: "Carretera Sierra Nevada, 18413 Capileira, Granada",
                lat: 37.0167,
                lng: -3.3500,
                segmento: "Hotel Rural",
                volumen: 45,
                notas: "Hotel en Sierra Nevada, dependencia gas√≥leo, inter√©s sostenibilidad"
            },
            {
                id: 2,
                nombre: "Carmen L√≥pez Mart√≠nez",
                cargo: "Responsable Sostenibilidad",
                empresa: "Hotel Rural Cortijo de T√°jar",
                email: "correo@cortijodetajar.es",
                telefono: "958 87 41 23",
                direccion: "Carretera A-92, km 203, 18360 Hu√©tor T√°jar, Granada",
                lat: 37.2833,
                lng: -3.9167,
                segmento: "Hotel Rural",
                volumen: 55,
                notas: "Hotel 4*, plan sostenibilidad 2025, reducir 40% emisiones"
            },
            {
                id: 3,
                nombre: "Ana Bel√©n S√°ez",
                cargo: "Directora T√©cnica",
                empresa: "Bodegas Riojanas",
                email: "info@bodegasriojanas.com",
                telefono: "941 45 40 50",
                direccion: "Av. Don Ricardo Ruiz de Azc√°rraga, 1, 26350 Cenicero, La Rioja",
                lat: 42.4667,
                lng: -2.5500,
                segmento: "Industria Agroalimentaria",
                volumen: 85,
                notas: "Control temperatura cr√≠tico fermentaci√≥n, 45.000‚Ç¨/a√±o propano"
            },
            {
                id: 4,
                nombre: "Roberto Mart√≠nez Velasco",
                cargo: "Responsable Producci√≥n",
                empresa: "Altos de Rioja",
                email: "info@altosderioja.com",
                telefono: "945 60 08 43",
                direccion: "Carretera de Laguardia, km 1.5, 01300 Elvillar, √Ålava",
                lat: 42.5167,
                lng: -2.6000,
                segmento: "Industria Agroalimentaria",
                volumen: 65,
                notas: "Bodega boutique, 38.000‚Ç¨/a√±o electricidad, marketing premium"
            },
            {
                id: 5,
                nombre: "Carlos Mundina Garc√≠a",
                cargo: "Concejal Eficiencia Energ√©tica",
                empresa: "Ayuntamiento de Valencia",
                email: "clima@valencia.es",
                telefono: "963 52 54 78",
                direccion: "Plaza del Ayuntamiento, 1, 46002 Valencia",
                lat: 39.4699,
                lng: -0.3763,
                segmento: "Ayuntamiento",
                volumen: 450,
                notas: "Meta descarbonizaci√≥n 2030, 2.8M‚Ç¨/a√±o presupuesto energ√©tico"
            },
            {
                id: 6,
                nombre: "Luisa Pastor Fern√°ndez",
                cargo: "T√©cnica Energ√≠a Sostenible",
                empresa: "Diputaci√≥n de Alicante",
                email: "energia@dipalicante.es",
                telefono: "965 15 45 89",
                direccion: "Avda. de la Estaci√≥n, 6, 03003 Alicante",
                lat: 38.3452,
                lng: -0.4810,
                segmento: "Ayuntamiento",
                volumen: 320,
                notas: "111 ayuntamientos provincia, fondo 11.9M‚Ç¨ disponible"
            },
            {
                id: 7,
                nombre: "Jos√© Antonio Ruiz",
                cargo: "Gerente",
                empresa: "Pol√≠gono Industrial Guadalhorce",
                email: "info@poligonoguadalhorce.org",
                telefono: "952 17 89 45",
                direccion: "C/ T√©cnicos, s/n, Pol√≠gono Guadalhorce, 29004 M√°laga",
                lat: 36.6833,
                lng: -4.4833,
                segmento: "Pol√≠gono Industrial",
                volumen: 280,
                notas: "73 empresas, sin gas natural, empresas deslocalizan por costes"
            },
            {
                id: 8,
                nombre: "Antonio P√©rez Maldonado",
                cargo: "Presidente",
                empresa: "APOMA - Asociaci√≥n Pol√≠gonos M√°laga",
                email: "info@apoma.es",
                telefono: "952 36 87 45",
                direccion: "Parque Tecnol√≥gico de Andaluc√≠a, M√°laga",
                lat: 36.6167,
                lng: -4.5000,
                segmento: "Pol√≠gono Industrial",
                volumen: 520,
                notas: "39 pol√≠gonos, +5000 empresas, energ√≠a 2¬∞ mayor coste"
            },
            {
                id: 9,
                nombre: "Miquel √Ängel Cerd√†",
                cargo: "Director Desarrollo",
                empresa: "Veolia Espa√±a - Divisi√≥n Biomasa",
                email: "miquel.cerda@veolia.com",
                telefono: "932 73 89 12",
                direccion: "C/ Pallars, 108, 08018 Barcelona",
                lat: 41.4036,
                lng: 2.1864,
                segmento: "Empresa ESE",
                volumen: 850,
                notas: "250 proyectos, integraci√≥n Imartec, expansi√≥n Arag√≥n/Valencia"
            },
            {
                id: 10,
                nombre: "Ramon Soler Mart√≠nez",
                cargo: "Director Comercial",
                empresa: "Sogesa Servicios Energ√©ticos",
                email: "comercial@sogesa.es",
                telefono: "934 52 67 89",
                direccion: "C/ Industria, 85, 08025 Barcelona",
                lat: 41.4036,
                lng: 2.1864,
                segmento: "Empresa ESE",
                volumen: 420,
                notas: "50+ proyectos biomasa, clientes hospitalarios/hoteleros"
            },
            {
                id: 11,
                nombre: "Patricia Raiola V√°zquez",
                cargo: "Directora Expansi√≥n",
                empresa: "Raiola Residencial",
                email: "direccion@raiolaresidencial.com",
                telefono: "981 56 78 92",
                direccion: "C/ Rosal√≠a de Castro, 45, 15701 Santiago de Compostela",
                lat: 42.8782,
                lng: -8.5448,
                segmento: "Residencia/Centro",
                volumen: 180,
                notas: "8 residencias Galicia, gas√≥leo costoso, confort 24h"
            },
            {
                id: 12,
                nombre: "Fernando Dom√≠nguez Castro",
                cargo: "Responsable T√©cnico",
                empresa: "Vitalia Home Galicia",
                email: "fdominguez@vitaliahome.es",
                telefono: "981 78 45 23",
                direccion: "C/ Rep√∫blica Argentina, 25, 15701 Santiago de Compostela",
                lat: 42.8782,
                lng: -8.5448,
                segmento: "Residencia/Centro",
                volumen: 220,
                notas: "12 centros Galicia, ISO 14001, 35% costes calefacci√≥n"
            }
        ];

        let mapa;
        let markersClientes = [];
        let markersCompetidores = [];
        let circulosCompetencia = [];
        let clienteEditando = null;
        let popupMinimized = false;
        let popupMaximized = false;

        // Variables para hacer el popup draggable
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;

        // Precios combustibles para calculadora
        const preciosCombustibles = {
            'gasoleo': 0.127,
            'gas': 0.082,
            'propano': 0.223,
            'electricidad': 0.200,
            'pellets': 0.063
        };

        // Inicializar mapa
        function inicializarMapa() {
            mapa = L.map('map').setView([40.0, -4.0], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(mapa);

            // Agregar Naturpellet
            L.marker([naturpellet.lat, naturpellet.lng], {
                icon: L.divIcon({
                    html: 'üêøÔ∏è',
                    iconSize: [30, 30],
                    className: 'marker-naturpellet'
                })
            }).addTo(mapa).bindPopup(`
                <strong>üêøÔ∏è NATURPELLET</strong><br>
                ${naturpellet.direccion}<br>
                <em>Planta Principal</em>
            `);

            cargarClientes();
            cargarCompetidores();
            actualizarDashboard();
            configurarDraggable();
        }

        function cargarClientes() {
            markersClientes.forEach(marker => mapa.removeLayer(marker));
            markersClientes = [];

            clientes.forEach(cliente => {
                const marker = L.marker([cliente.lat, cliente.lng], {
                    icon: L.divIcon({
                        html: getIconoSegmento(cliente.segmento),
                        iconSize: [25, 25],
                        className: 'marker-cliente'
                    })
                }).addTo(mapa);

                marker.bindPopup(`
                    <div style="min-width: 280px;">
                        <strong>${cliente.empresa}</strong><br>
                        <strong>Contacto:</strong> ${cliente.nombre}<br>
                        <strong>Cargo:</strong> ${cliente.cargo}<br>
                        <strong>Email:</strong> ${cliente.email}<br>
                        <strong>Tel√©fono:</strong> ${cliente.telefono}<br>
                        <strong>Segmento:</strong> ${cliente.segmento}<br>
                        <strong>Volumen:</strong> ${cliente.volumen} ton/a√±o<br>
                        <strong>Notas:</strong> ${cliente.notas}<br>
                        <div style="margin-top: 15px; display: flex; gap: 5px;">
                            <button onclick="abrirPopupCliente(${cliente.id})" style="background: #27ae60; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">üìã Ver Detalles</button>
                            <button onclick="editarCliente(${cliente.id})" style="background: #f39c12; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">‚úèÔ∏è Editar</button>
                            <button onclick="eliminarCliente(${cliente.id})" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                `);

                markersClientes.push(marker);
            });

            renderizarListaClientes();
        }

        function cargarCompetidores() {
            markersCompetidores.forEach(marker => mapa.removeLayer(marker));
            circulosCompetencia.forEach(circle => mapa.removeLayer(circle));
            markersCompetidores = [];
            circulosCompetencia = [];

            competidores.forEach(comp => {
                const marker = L.marker([comp.lat, comp.lng], {
                    icon: L.divIcon({
                        html: 'üè≠',
                        iconSize: [25, 25],
                        className: 'marker-competidor'
                    })
                }).addTo(mapa);

                marker.bindPopup(`
                    <strong>üè≠ ${comp.nombre}</strong><br>
                    ${comp.ciudad}<br>
                    <strong>Capacidad:</strong> ${comp.capacidad}
                `);

                // C√≠rculo 150km
                const circle = L.circle([comp.lat, comp.lng], {
                    color: '#e74c3c',
                    fillColor: '#e74c3c',
                    fillOpacity: 0.1,
                    radius: 150000,
                    dashArray: '10, 10'
                }).addTo(mapa);

                markersCompetidores.push(marker);
                circulosCompetencia.push(circle);
            });
        }

        function configurarDraggable() {
            const popup = document.getElementById('cliente-popup');
            const header = popup.querySelector('.modal-header');

            header.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
        }

        function dragStart(e) {
            const popup = document.getElementById('cliente-popup');
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;

            if (e.target === e.currentTarget) {
                isDragging = true;
                popup.style.cursor = 'grabbing';
            }
        }

        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                const popup = document.getElementById('cliente-popup');

                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;

                xOffset = currentX;
                yOffset = currentY;

                popup.style.transform = `translate(${currentX}px, ${currentY}px)`;
            }
        }

        function dragEnd(e) {
            const popup = document.getElementById('cliente-popup');
            initialX = currentX;
            initialY = currentY;

            isDragging = false;
            popup.style.cursor = 'default';
        }

        function abrirPopupCliente(id) {
            const cliente = clientes.find(c => c.id === id);
            if (!cliente) return;

            clienteEditando = cliente;

            // Llenar formulario
            llenarFormulario(cliente);

            // Llenar an√°lisis
            llenarAnalisis(cliente);

            // Configurar popup
            document.getElementById('popup-titulo').textContent = cliente.empresa;
            document.getElementById('cliente-popup').style.display = 'block';

            // Centrar popup
            centrarPopup();

            // Ir a tab informaci√≥n
            cambiarTab('info');
        }

        function llenarFormulario(cliente) {
            document.getElementById('nombre').value = cliente.nombre;
            document.getElementById('cargo').value = cliente.cargo;
            document.getElementById('empresa').value = cliente.empresa;
            document.getElementById('email').value = cliente.email;
            document.getElementById('telefono').value = cliente.telefono;
            document.getElementById('direccion').value = cliente.direccion;
            document.getElementById('latitud').value = cliente.lat;
            document.getElementById('longitud').value = cliente.lng;
            document.getElementById('segmento').value = cliente.segmento;
            document.getElementById('volumen').value = cliente.volumen;
            document.getElementById('notas').value = cliente.notas;
        }

        function llenarAnalisis(cliente) {
            const analisis = datosAnalisis[cliente.id];

            if (analisis) {
                // Puntos de dolor
                const puntosDolorList = document.getElementById('puntos-dolor');
                puntosDolorList.innerHTML = '';
                analisis.puntosDolor.forEach(punto => {
                    const li = document.createElement('li');
                    li.textContent = punto;
                    puntosDolorList.appendChild(li);
                });

                // Propuesta de valor
                const propuestaList = document.getElementById('propuesta-valor');
                propuestaList.innerHTML = '';
                analisis.propuestaNaturpellet.forEach(propuesta => {
                    const li = document.createElement('li');
                    li.textContent = propuesta;
                    propuestaList.appendChild(li);
                });

                // Por qu√© Naturpellet
                document.getElementById('porque-naturpellet').textContent = analisis.porqueNaturpellet;
            }
        }

        function centrarPopup() {
            const popup = document.getElementById('cliente-popup');
            const rect = popup.getBoundingClientRect();

            xOffset = (window.innerWidth - rect.width) / 2;
            yOffset = (window.innerHeight - rect.height) / 2;

            popup.style.transform = `translate(${xOffset}px, ${yOffset}px)`;
        }

        function cambiarTab(tabName) {
            // Remover active de todos los tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Activar tab seleccionado
            document.querySelector(`[onclick="cambiarTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function minimizePopup() {
            const popup = document.getElementById('cliente-popup');
            popupMinimized = !popupMinimized;

            if (popupMinimized) {
                popup.classList.add('minimized');
            } else {
                popup.classList.remove('minimized');
            }
        }

        function maximizePopup() {
            const popup = document.getElementById('cliente-popup');
            popupMaximized = !popupMaximized;

            if (popupMaximized) {
                popup.style.width = '95vw';
                popup.style.height = '95vh';
                popup.style.transform = 'translate(2.5vw, 2.5vh)';
                xOffset = window.innerWidth * 0.025;
                yOffset = window.innerHeight * 0.025;
            } else {
                popup.style.width = '';
                popup.style.height = '';
                centrarPopup();
            }
        }

        function cerrarPopup() {
            document.getElementById('cliente-popup').style.display = 'none';
            popupMinimized = false;
            popupMaximized = false;
        }

        function calcularAhorro() {
            const combustible = document.getElementById('combustible-actual').value;
            const costeActual = parseFloat(document.getElementById('coste-actual').value);
            const superficie = parseFloat(document.getElementById('superficie-calc').value);

            if (!combustible || !costeActual) return;

            // Calcular kWh anuales
            const kwhAnuales = costeActual / preciosCombustibles[combustible];
            document.getElementById('consumo-kwh').value = Math.round(kwhAnuales);

            // Calcular coste con pellets
            const costePellets = kwhAnuales * preciosCombustibles.pellets;
            const ahorroAnual = costeActual - costePellets;
            const ahorroPorcentaje = (ahorroAnual / costeActual) * 100;

            // Calcular toneladas pellets (4.8 kWh/kg)
            const toneladasPellets = kwhAnuales / 4800;

            // Estimar ROI (basado en superficie)
            const inversionEstimada = superficie ? superficie * 100 : 50000; // 100‚Ç¨/m¬≤ promedio
            const roiAnos = inversionEstimada / ahorroAnual;

            // Mostrar resultados
            document.getElementById('ahorro-anual').textContent = formatCurrency(ahorroAnual);
            document.getElementById('ahorro-euros').textContent = formatCurrency(ahorroAnual);
            document.getElementById('ahorro-porcentaje').textContent = Math.round(ahorroPorcentaje) + '%';
            document.getElementById('toneladas-necesarias').textContent = Math.round(toneladasPellets) + ' ton/a√±o';
            document.getElementById('roi-anos').textContent = roiAnos.toFixed(1) + ' a√±os';
            document.getElementById('ahorro-10-anos').textContent = formatCurrency(ahorroAnual * 10);

            document.getElementById('resultado-calculo').style.display = 'block';
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-ES', {
                style: 'currency',
                currency: 'EUR',
                maximumFractionDigits: 0
            }).format(amount);
        }

        function getIconoSegmento(segmento) {
            const iconos = {
                'Hotel Rural': 'üè®',
                'Industria Agroalimentaria': 'üç∑',
                'Ayuntamiento': 'üèõÔ∏è',
                'Pol√≠gono Industrial': 'üè≠',
                'Empresa ESE': '‚ö°',
                'Residencia/Centro': 'üè•'
            };
            return iconos[segmento] || 'üìç';
        }

        function renderizarListaClientes() {
            const container = document.getElementById('clientes-container');
            const segmentoFiltro = document.getElementById('filter-segmento').value;

            const clientesFiltrados = segmentoFiltro 
                ? clientes.filter(c => c.segmento === segmentoFiltro)
                : clientes;

            container.innerHTML = '';

            clientesFiltrados.forEach(cliente => {
                const div = document.createElement('div');
                div.className = 'client-card';
                div.innerHTML = `
                    <div class="client-actions">
                        <button class="btn-small btn-view" onclick="abrirPopupCliente(${cliente.id})">üëÅÔ∏è</button>
                        <button class="btn-small btn-edit" onclick="editarCliente(${cliente.id})">‚úèÔ∏è</button>
                        <button class="btn-small btn-delete" onclick="eliminarCliente(${cliente.id})">üóëÔ∏è</button>
                    </div>
                    <h4>${getIconoSegmento(cliente.segmento)} ${cliente.empresa}</h4>
                    <div class="client-info">
                        <div><strong>Contacto:</strong> ${cliente.nombre}</div>
                        <div><strong>Cargo:</strong> ${cliente.cargo}</div>
                        <div><strong>Email:</strong> ${cliente.email}</div>
                        <div><strong>Tel√©fono:</strong> ${cliente.telefono}</div>
                        <div><strong>Volumen:</strong> ${cliente.volumen} ton/a√±o</div>
                        <div><strong>Segmento:</strong> ${cliente.segmento}</div>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>Direcci√≥n:</strong> ${cliente.direccion}<br>
                        <strong>Notas:</strong> ${cliente.notas}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function actualizarDashboard() {
            const totalClientes = clientes.length;
            const volumenTotal = clientes.reduce((sum, c) => sum + c.volumen, 0);
            const ingresosTotal = volumenTotal * 300; // 300‚Ç¨/ton promedio

            document.getElementById('total-clientes').textContent = totalClientes;
            document.getElementById('volumen-total').textContent = volumenTotal.toLocaleString();
            document.getElementById('ingresos-potencial').textContent = (ingresosTotal / 1000000).toFixed(2) + 'M‚Ç¨';
        }

        function filtrarMapa() {
            cargarClientes();
        }

        function toggleCompetidores() {
            const mostrar = document.getElementById('mostrar-competidores').value === 'true';
            markersCompetidores.forEach(marker => {
                if (mostrar) {
                    marker.addTo(mapa);
                } else {
                    mapa.removeLayer(marker);
                }
            });
        }

        function toggleZonas150() {
            const mostrar = document.getElementById('mostrar-zonas').value === 'true';
            circulosCompetencia.forEach(circle => {
                if (mostrar) {
                    circle.addTo(mapa);
                } else {
                    mapa.removeLayer(circle);
                }
            });
        }

        function abrirModalAgregar() {
            clienteEditando = null;
            document.getElementById('popup-titulo').textContent = 'Agregar Nuevo Cliente';
            document.getElementById('cliente-form').reset();
            document.getElementById('cliente-popup').style.display = 'block';
            centrarPopup();
            cambiarTab('info');
        }

        function editarCliente(id) {
            abrirPopupCliente(id);
            cambiarTab('info');
        }

        function eliminarCliente(id) {
            if (confirm('¬øEst√° seguro de eliminar este cliente?')) {
                clientes = clientes.filter(c => c.id !== id);
                cargarClientes();
                actualizarDashboard();
                cerrarPopup();
            }
        }

        // Manejar formulario
        document.getElementById('cliente-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = {
                nombre: document.getElementById('nombre').value,
                cargo: document.getElementById('cargo').value,
                empresa: document.getElementById('empresa').value,
                email: document.getElementById('email').value,
                telefono: document.getElementById('telefono').value,
                direccion: document.getElementById('direccion').value,
                lat: parseFloat(document.getElementById('latitud').value),
                lng: parseFloat(document.getElementById('longitud').value),
                segmento: document.getElementById('segmento').value,
                volumen: parseInt(document.getElementById('volumen').value) || 0,
                notas: document.getElementById('notas').value
            };

            if (clienteEditando) {
                // Editar existente
                Object.assign(clienteEditando, formData);
            } else {
                // Agregar nuevo
                formData.id = Math.max(...clientes.map(c => c.id)) + 1;
                clientes.push(formData);
            }

            cargarClientes();
            actualizarDashboard();
            cerrarPopup();
        });

        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // T√≠tulo
            doc.setFontSize(20);
            doc.text('NATURPELLET - Informe Ejecutivo Expansi√≥n', 20, 20);

            doc.setFontSize(12);
            doc.text('Plan de Expansi√≥n Comercial 2025', 20, 30);
            doc.text('Fecha: ' + new Date().toLocaleDateString('es-ES'), 20, 40);

            // Resumen
            doc.setFontSize(14);
            doc.text('Resumen Ejecutivo:', 20, 55);
            doc.setFontSize(10);
            doc.text(`Total Clientes Potenciales: ${clientes.length}`, 20, 65);
            doc.text(`Volumen Total: ${clientes.reduce((sum, c) => sum + c.volumen, 0).toLocaleString()} ton/a√±o`, 20, 75);
            doc.text(`Ingresos Potenciales: ${(clientes.reduce((sum, c) => sum + c.volumen, 0) * 300 / 1000000).toFixed(2)}M‚Ç¨`, 20, 85);

            // Lista de clientes
            let y = 100;
            doc.setFontSize(12);
            doc.text('Clientes Identificados:', 20, y);
            y += 10;

            doc.setFontSize(8);
            clientes.forEach((cliente, index) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }

                doc.text(`${index + 1}. ${cliente.empresa}`, 20, y);
                y += 8;
                doc.text(`   Contacto: ${cliente.nombre} (${cliente.cargo})`, 20, y);
                y += 6;
                doc.text(`   Email: ${cliente.email} | Tel: ${cliente.telefono}`, 20, y);
                y += 6;
                doc.text(`   Segmento: ${cliente.segmento} | Volumen: ${cliente.volumen} ton/a√±o`, 20, y);
                y += 6;
                doc.text(`   Direcci√≥n: ${cliente.direccion}`, 20, y);
                y += 10;
            });

            doc.save('naturpellet-informe-expansion.pdf');
        }

        function exportarCSV() {
            const headers = ['ID', 'Nombre', 'Cargo', 'Empresa', 'Email', 'Tel√©fono', 'Direcci√≥n', 'Segmento', 'Volumen (ton/a√±o)', 'Latitud', 'Longitud', 'Notas'];

            let csv = headers.join(',') + '\n';

            clientes.forEach(cliente => {
                const row = [
                    cliente.id,
                    `"${cliente.nombre}"`,
                    `"${cliente.cargo}"`,
                    `"${cliente.empresa}"`,
                    cliente.email,
                    cliente.telefono,
                    `"${cliente.direccion}"`,
                    `"${cliente.segmento}"`,
                    cliente.volumen,
                    cliente.lat,
                    cliente.lng,
                    `"${cliente.notas}"`
                ];
                csv += row.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'naturpellet-clientes.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            inicializarMapa();
        });

        // Cerrar popup con ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                cerrarPopup();
            }
        });
    </script>
</body>
</html>
