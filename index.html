<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe Ejecutivo Expansi√≥n | Naturpellet</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- SUPABASE JS LIBRARY -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f8f6f3;
            color: #2c2c2c;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #5a4a3a 0%, #6b4d32 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 4em;
        }

        .company-info h1 {
            font-size: 2.2em;
            margin-bottom: 5px;
        }

        .company-info p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .report-date {
            text-align: right;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(90, 74, 58, 0.1);
            text-align: center;
            border-top: 4px solid #d4af37;
        }

        .dashboard-card h3 {
            font-size: 2.8em;
            color: #5a4a3a;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .dashboard-card p {
            color: #666;
            font-weight: 500;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .map-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(90, 74, 58, 0.1);
        }

        .map-section h2 {
            color: #5a4a3a;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-left: 4px solid #d4af37;
            padding-left: 15px;
        }

        #map {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            border: 2px solid #d4af37;
        }

        .controls-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(90, 74, 58, 0.1);
            height: fit-content;
        }

        .controls-section h3 {
            color: #5a4a3a;
            margin-bottom: 20px;
            border-left: 4px solid #d4af37;
            padding-left: 15px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            color: #5a4a3a;
            font-weight: bold;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #d4af37;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-primary {
            background: #6b4d32;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-bottom: 10px;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background: #5a4a3a;
        }

        .btn-secondary {
            background: #d4af37;
            color: #5a4a3a;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-bottom: 10px;
        }

        .clients-list {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(90, 74, 58, 0.1);
        }

        .clients-list h2 {
            color: #5a4a3a;
            margin-bottom: 20px;
            border-left: 4px solid #d4af37;
            padding-left: 15px;
        }

        .client-card {
            background: #f8f6f3;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #d4af37;
            position: relative;
        }

        .client-card h4 {
            color: #5a4a3a;
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .client-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .client-info div {
            font-size: 0.9em;
        }

        .client-info strong {
            color: #6b4d32;
        }

        .client-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-edit { background: #f39c12; color: white; }
        .btn-delete { background: #e74c3c; color: white; }
        .btn-view { background: #27ae60; color: white; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #5a4a3a;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #d4af37;
            border-radius: 4px;
        }

        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            box-shadow: 0 2px 10px rgba(90, 74, 58, 0.1);
        }

        .legend h4 {
            color: #5a4a3a;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .legend-marker {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid #333;
        }

        .marker-naturpellet { background: #2ecc71; }
        .marker-cliente { background: #3498db; }
        .marker-competidor { background: #e74c3c; }
        .marker-zona150 { background: transparent; border: 2px dashed #e74c3c; }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6b4d32;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .client-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">üêøÔ∏è</div>
                <div class="company-info">
                    <h1>NATURPELLET</h1>
                    <p>Pellet 100% Natural y Ecol√≥gico | Sanchonu√±o, Segovia</p>
                </div>
            </div>
            <div class="report-date">
                <h3>Informe Ejecutivo</h3>
                <p>Plan Expansi√≥n 2025</p>
                <p>8 Octubre 2025</p>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Dashboard -->
        <div class="dashboard-grid">
            <div class="dashboard-card">
                <h3 id="total-clientes">0</h3>
                <p>Clientes Potenciales</p>
            </div>
            <div class="dashboard-card">
                <h3 id="volumen-total">0</h3>
                <p>Toneladas/A√±o Potencial</p>
            </div>
            <div class="dashboard-card">
                <h3 id="ingresos-potencial">0.00M‚Ç¨</h3>
                <p>Ingresos Potenciales</p>
            </div>
            <div class="dashboard-card">
                <h3 id="competidores">5</h3>
                <p>Grandes Competidores</p>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div class="main-content">
            <div class="map-section">
                <h2>üìç Mapa Estrat√©gico de Expansi√≥n</h2>
                <div id="map"></div>
                <div class="legend">
                    <h4>Leyenda</h4>
                    <div class="legend-item">
                        <div class="legend-marker marker-naturpellet"></div>
                        <span>Naturpellet (Sanchonu√±o)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker marker-cliente"></div>
                        <span>Clientes Potenciales</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker marker-competidor"></div>
                        <span>Competidores Grandes</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-marker marker-zona150"></div>
                        <span>Zona 150km Competidores</span>
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <h3>‚öôÔ∏è Controles</h3>

                <div class="control-group">
                    <label for="filter-segmento">Filtrar por Segmento</label>
                    <select id="filter-segmento" onchange="filtrarMapa()">
                        <option value="">Todos</option>
                        <option value="Hotel Rural">Hoteles</option>
                        <option value="Industria Agroalimentaria">Industria</option>
                        <option value="Ayuntamiento">Ayuntamientos</option>
                        <option value="Pol√≠gono Industrial">Pol√≠gonos</option>
                        <option value="Empresa ESE">ESE</option>
                        <option value="Residencia/Centro">Residencias</option>
                        <option value="Centro educativo">Educativo</option>
                        <option value="Cl√≠nica/Sanitario">Sanitario</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="mostrar-competidores">Mostrar Competidores</label>
                    <select id="mostrar-competidores" onchange="toggleCompetidores()">
                        <option value="true">S√≠</option>
                        <option value="false">No</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="mostrar-zonas">Mostrar Zonas 150km</label>
                    <select id="mostrar-zonas" onchange="toggleZonas150()">
                        <option value="true">S√≠</option>
                        <option value="false">No</option>
                    </select>
                </div>

                <button class="btn-primary" onclick="abrirModalAgregar()">
                    ‚ûï Agregar Cliente
                </button>

                <button class="btn-secondary" onclick="sincronizarConSupabase()">
                    üîÑ Sincronizar Base Datos
                </button>

                <button class="btn-secondary" onclick="exportarPDF()">
                    üìÑ Exportar PDF
                </button>

                <button class="btn-secondary" onclick="exportarCSV()">
                    üìä Exportar CSV
                </button>
            </div>
        </div>

        <!-- Lista de Clientes -->
        <div class="clients-list">
            <h2>üë• Clientes Potenciales Identificados</h2>
            <div class="loading" id="loading-indicator">Cargando datos desde Supabase...</div>
            <div id="clientes-container"></div>
        </div>
    </div>

    <!-- Modal Agregar/Editar Cliente -->
    <div id="cliente-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal()">&times;</span>
            <h2 id="modal-titulo">Agregar Nuevo Cliente</h2>
            <form id="cliente-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nombre">Nombre Contacto</label>
                        <input type="text" id="nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="cargo">Cargo</label>
                        <input type="text" id="cargo">
                    </div>
                    <div class="form-group">
                        <label for="empresa">Empresa</label>
                        <input type="text" id="empresa" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email">
                    </div>
                    <div class="form-group">
                        <label for="telefono">Tel√©fono</label>
                        <input type="tel" id="telefono">
                    </div>
                    <div class="form-group">
                        <label for="segmento">Segmento</label>
                        <select id="segmento" required>
                            <option value="">Seleccionar...</option>
                            <option value="Hotel Rural">Hotel Rural</option>
                            <option value="Industria Agroalimentaria">Industria Agroalimentaria</option>
                            <option value="Ayuntamiento">Ayuntamiento</option>
                            <option value="Pol√≠gono Industrial">Pol√≠gono Industrial</option>
                            <option value="Empresa ESE">Empresa ESE</option>
                            <option value="Residencia/Centro">Residencia/Centro</option>
                            <option value="Centro educativo">Centro educativo</option>
                            <option value="Cl√≠nica/Sanitario">Cl√≠nica/Sanitario</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="direccion">Direcci√≥n</label>
                    <input type="text" id="direccion" required>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="latitud">Latitud</label>
                        <input type="number" id="latitud" step="any" placeholder="Ej: 40.4168">
                    </div>
                    <div class="form-group">
                        <label for="longitud">Longitud</label>
                        <input type="number" id="longitud" step="any" placeholder="Ej: -3.7038">
                    </div>
                </div>
                <div class="form-group">
                    <label for="volumen">Volumen Potencial (ton/a√±o)</label>
                    <input type="number" id="volumen" min="0">
                </div>
                <div class="form-group">
                    <label for="notas">Notas</label>
                    <textarea id="notas" rows="3"></textarea>
                </div>
                <button type="submit" class="btn-primary">üíæ Guardar Cliente</button>
            </form>
        </div>
    </div>

    <script>
        // ====================================================================
        // INICIALIZACI√ìN DE SUPABASE
        // ====================================================================
        const SUPABASE_URL = 'https://naaatgzpzfgzplqlszew.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5hYWF0Z3pwemZnenBscWxzemV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDk5NjYsImV4cCI6MjA3NTQ4NTk2Nn0.C1V7UyNxBYQyb904chvYHwRtYN6CVY_si26rHaSm3D4';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ====================================================================
        // VARIABLES GLOBALES
        // ====================================================================
        const naturpellet = {
            lat: 41.2951,
            lng: -4.3838,
            nombre: "Naturpellet",
            direccion: "Salida 60, A-601, 40297 Sanchonu√±o, Segovia"
        };

        const competidores = [
            { nombre: "Arapellet", lat: 41.5167, lng: -1.4167, ciudad: "Erla, Zaragoza", capacidad: "140,000 ton/a√±o" },
            { nombre: "Ribpellet", lat: 42.0167, lng: -3.7000, ciudad: "Huerta de Rey, Burgos", capacidad: "50,000 ton/a√±o" },
            { nombre: "Pellet Extremadura", lat: 38.8794, lng: -6.9707, ciudad: "Badajoz", capacidad: "15,000 ton/a√±o" },
            { nombre: "Biomasas Forestales", lat: 43.4833, lng: -7.2000, ciudad: "Trabada, Lugo", capacidad: "N/D" },
            { nombre: "Astillastur", lat: 43.3614, lng: -5.8593, ciudad: "Oviedo, Asturias", capacidad: "N/D" }
        ];

        let mapa;
        let markersClientes = [];
        let markersCompetidores = [];
        let circulosCompetencia = [];
        let clienteEditando = null;
        let clientes = [];

        // ====================================================================
        // FUNCIONES SUPABASE
        // ====================================================================

        async function cargarClientesDesdeSupabase() {
            try {
                document.getElementById('loading-indicator').style.display = 'block';

                const { data, error } = await supabase
                    .from('clientes_potenciales')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error al cargar clientes:', error);
                    alert('Error al cargar clientes desde Supabase. Revisa la consola.');
                    return;
                }

                clientes = data.map(cliente => ({
                    id: cliente.id,
                    nombre: cliente.contacto_nombre || '',
                    cargo: cliente.contacto_cargo || '',
                    empresa: cliente.nombre_empresa || '',
                    email: cliente.contacto_email || '',
                    telefono: cliente.contacto_telefono || '',
                    direccion: cliente.direccion || '',
                    lat: parseFloat(cliente.latitud) || 40.0,
                    lng: parseFloat(cliente.longitud) || -4.0,
                    segmento: cliente.segmento || '',
                    volumen: parseInt(cliente.volumen_potencial) || 0,
                    notas: cliente.notas || ''
                }));

                document.getElementById('loading-indicator').style.display = 'none';

                cargarClientes();
                actualizarDashboard();

                console.log(`‚úÖ ${clientes.length} clientes cargados desde Supabase`);

            } catch (err) {
                console.error('Error inesperado:', err);
                document.getElementById('loading-indicator').innerText = 'Error al cargar datos. Verifica la configuraci√≥n.';
            }
        }

        async function guardarClienteEnSupabase(datosCliente) {
            try {
                const clienteSupabase = {
                    nombre_empresa: datosCliente.empresa,
                    contacto_nombre: datosCliente.nombre,
                    contacto_cargo: datosCliente.cargo,
                    contacto_email: datosCliente.email,
                    contacto_telefono: datosCliente.telefono,
                    segmento: datosCliente.segmento,
                    direccion: datosCliente.direccion,
                    latitud: parseFloat(datosCliente.lat),
                    longitud: parseFloat(datosCliente.lng),
                    volumen_potencial: parseInt(datosCliente.volumen),
                    notas: datosCliente.notas
                };

                const { data, error } = await supabase
                    .from('clientes_potenciales')
                    .insert([clienteSupabase])
                    .select();

                if (error) {
                    console.error('Error al guardar:', error);
                    alert('Error al guardar cliente en Supabase: ' + error.message);
                    return null;
                }

                alert('‚úÖ Cliente guardado exitosamente en Supabase');
                return data[0];

            } catch (err) {
                console.error('Error inesperado al guardar:', err);
                alert('Error inesperado al guardar cliente');
                return null;
            }
        }

        async function actualizarClienteEnSupabase(id, datosCliente) {
            try {
                const clienteSupabase = {
                    nombre_empresa: datosCliente.empresa,
                    contacto_nombre: datosCliente.nombre,
                    contacto_cargo: datosCliente.cargo,
                    contacto_email: datosCliente.email,
                    contacto_telefono: datosCliente.telefono,
                    segmento: datosCliente.segmento,
                    direccion: datosCliente.direccion,
                    latitud: parseFloat(datosCliente.lat),
                    longitud: parseFloat(datosCliente.lng),
                    volumen_potencial: parseInt(datosCliente.volumen),
                    notas: datosCliente.notas
                };

                const { data, error } = await supabase
                    .from('clientes_potenciales')
                    .update(clienteSupabase)
                    .eq('id', id)
                    .select();

                if (error) {
                    console.error('Error al actualizar:', error);
                    alert('Error al actualizar cliente: ' + error.message);
                    return false;
                }

                alert('‚úÖ Cliente actualizado exitosamente');
                return true;

            } catch (err) {
                console.error('Error inesperado al actualizar:', err);
                return false;
            }
        }

        async function eliminarClienteDeSupabase(id) {
            try {
                const { error } = await supabase
                    .from('clientes_potenciales')
                    .delete()
                    .eq('id', id);

                if (error) {
                    console.error('Error al eliminar:', error);
                    alert('Error al eliminar cliente: ' + error.message);
                    return false;
                }

                alert('‚úÖ Cliente eliminado de Supabase');
                return true;

            } catch (err) {
                console.error('Error inesperado al eliminar:', err);
                return false;
            }
        }

        async function sincronizarConSupabase() {
            await cargarClientesDesdeSupabase();
        }

        // ====================================================================
        // FUNCIONES MAPA
        // ====================================================================

        function inicializarMapa() {
            mapa = L.map('map').setView([40.0, -4.0], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(mapa);

            L.marker([naturpellet.lat, naturpellet.lng], {
                icon: L.divIcon({
                    html: 'üêøÔ∏è',
                    iconSize: [30, 30],
                    className: 'marker-naturpellet'
                })
            }).addTo(mapa).bindPopup(`
                <strong>üêøÔ∏è NATURPELLET</strong><br>
                ${naturpellet.direccion}<br>
                <em>Planta Principal</em>
            `);

            cargarCompetidores();
            cargarClientesDesdeSupabase();
        }

        function cargarClientes() {
            markersClientes.forEach(marker => mapa.removeLayer(marker));
            markersClientes = [];

            const segmentoFiltro = document.getElementById('filter-segmento').value;
            const clientesFiltrados = segmentoFiltro 
                ? clientes.filter(c => c.segmento === segmentoFiltro)
                : clientes;

            clientesFiltrados.forEach(cliente => {
                const marker = L.marker([cliente.lat, cliente.lng], {
                    icon: L.divIcon({
                        html: getIconoSegmento(cliente.segmento),
                        iconSize: [25, 25],
                        className: 'marker-cliente'
                    })
                }).addTo(mapa);

                marker.bindPopup(`
                    <div style="min-width: 250px;">
                        <strong>${cliente.empresa}</strong><br>
                        <strong>Contacto:</strong> ${cliente.nombre}<br>
                        <strong>Cargo:</strong> ${cliente.cargo}<br>
                        <strong>Email:</strong> ${cliente.email}<br>
                        <strong>Tel√©fono:</strong> ${cliente.telefono}<br>
                        <strong>Segmento:</strong> ${cliente.segmento}<br>
                        <strong>Volumen:</strong> ${cliente.volumen} ton/a√±o<br>
                        <strong>Notas:</strong> ${cliente.notas}<br>
                        <div style="margin-top: 10px;">
                            <button onclick="editarCliente('${cliente.id}')" style="margin-right: 5px; padding: 5px 10px; background: #f39c12; color: white; border: none; border-radius: 4px; cursor: pointer;">Editar</button>
                            <button onclick="eliminarCliente('${cliente.id}')" style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">Eliminar</button>
                        </div>
                    </div>
                `);

                markersClientes.push(marker);
            });

            renderizarListaClientes();
        }

        function cargarCompetidores() {
            markersCompetidores.forEach(marker => mapa.removeLayer(marker));
            circulosCompetencia.forEach(circle => mapa.removeLayer(circle));
            markersCompetidores = [];
            circulosCompetencia = [];

            competidores.forEach(comp => {
                const marker = L.marker([comp.lat, comp.lng], {
                    icon: L.divIcon({
                        html: 'üè≠',
                        iconSize: [25, 25],
                        className: 'marker-competidor'
                    })
                }).addTo(mapa);

                marker.bindPopup(`
                    <strong>üè≠ ${comp.nombre}</strong><br>
                    ${comp.ciudad}<br>
                    <strong>Capacidad:</strong> ${comp.capacidad}
                `);

                const circle = L.circle([comp.lat, comp.lng], {
                    color: '#e74c3c',
                    fillColor: '#e74c3c',
                    fillOpacity: 0.1,
                    radius: 150000,
                    dashArray: '10, 10'
                }).addTo(mapa);

                markersCompetidores.push(marker);
                circulosCompetencia.push(circle);
            });
        }

        function getIconoSegmento(segmento) {
            const iconos = {
                'Hotel Rural': 'üè®',
                'Industria Agroalimentaria': 'üç∑',
                'Ayuntamiento': 'üèõÔ∏è',
                'Pol√≠gono Industrial': 'üè≠',
                'Empresa ESE': '‚ö°',
                'Residencia/Centro': 'üè•',
                'Centro educativo': 'üéì',
                'Cl√≠nica/Sanitario': 'üè•'
            };
            return iconos[segmento] || 'üìç';
        }

        function renderizarListaClientes() {
            const container = document.getElementById('clientes-container');
            const segmentoFiltro = document.getElementById('filter-segmento').value;

            const clientesFiltrados = segmentoFiltro 
                ? clientes.filter(c => c.segmento === segmentoFiltro)
                : clientes;

            container.innerHTML = '';

            clientesFiltrados.forEach(cliente => {
                const div = document.createElement('div');
                div.className = 'client-card';
                div.innerHTML = `
                    <div class="client-actions">
                        <button class="btn-small btn-edit" onclick="editarCliente('${cliente.id}')">‚úèÔ∏è</button>
                        <button class="btn-small btn-delete" onclick="eliminarCliente('${cliente.id}')">üóëÔ∏è</button>
                    </div>
                    <h4>${getIconoSegmento(cliente.segmento)} ${cliente.empresa}</h4>
                    <div class="client-info">
                        <div><strong>Contacto:</strong> ${cliente.nombre}</div>
                        <div><strong>Cargo:</strong> ${cliente.cargo}</div>
                        <div><strong>Email:</strong> ${cliente.email}</div>
                        <div><strong>Tel√©fono:</strong> ${cliente.telefono}</div>
                        <div><strong>Volumen:</strong> ${cliente.volumen} ton/a√±o</div>
                        <div><strong>Segmento:</strong> ${cliente.segmento}</div>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>Direcci√≥n:</strong> ${cliente.direccion}<br>
                        <strong>Notas:</strong> ${cliente.notas}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function actualizarDashboard() {
            const totalClientes = clientes.length;
            const volumenTotal = clientes.reduce((sum, c) => sum + c.volumen, 0);
            const ingresosTotal = volumenTotal * 300;

            document.getElementById('total-clientes').textContent = totalClientes;
            document.getElementById('volumen-total').textContent = volumenTotal.toLocaleString();
            document.getElementById('ingresos-potencial').textContent = (ingresosTotal / 1000000).toFixed(2) + 'M‚Ç¨';
        }

        function filtrarMapa() {
            cargarClientes();
        }

        function toggleCompetidores() {
            const mostrar = document.getElementById('mostrar-competidores').value === 'true';
            markersCompetidores.forEach(marker => {
                if (mostrar) {
                    marker.addTo(mapa);
                } else {
                    mapa.removeLayer(marker);
                }
            });
        }

        function toggleZonas150() {
            const mostrar = document.getElementById('mostrar-zonas').value === 'true';
            circulosCompetencia.forEach(circle => {
                if (mostrar) {
                    circle.addTo(mapa);
                } else {
                    mapa.removeLayer(circle);
                }
            });
        }

        // ====================================================================
        // FUNCIONES MODAL Y FORMULARIO
        // ====================================================================

        function abrirModalAgregar() {
            clienteEditando = null;
            document.getElementById('modal-titulo').textContent = 'Agregar Nuevo Cliente';
            document.getElementById('cliente-form').reset();
            document.getElementById('cliente-modal').style.display = 'block';
        }

        function editarCliente(id) {
            clienteEditando = clientes.find(c => c.id == id);
            if (!clienteEditando) return;

            document.getElementById('modal-titulo').textContent = 'Editar Cliente';

            document.getElementById('nombre').value = clienteEditando.nombre;
            document.getElementById('cargo').value = clienteEditando.cargo;
            document.getElementById('empresa').value = clienteEditando.empresa;
            document.getElementById('email').value = clienteEditando.email;
            document.getElementById('telefono').value = clienteEditando.telefono;
            document.getElementById('direccion').value = clienteEditando.direccion;
            document.getElementById('latitud').value = clienteEditando.lat;
            document.getElementById('longitud').value = clienteEditando.lng;
            document.getElementById('segmento').value = clienteEditando.segmento;
            document.getElementById('volumen').value = clienteEditando.volumen;
            document.getElementById('notas').value = clienteEditando.notas;

            document.getElementById('cliente-modal').style.display = 'block';
        }

        async function eliminarCliente(id) {
            if (!confirm('¬øEst√° seguro de eliminar este cliente?')) return;

            const eliminado = await eliminarClienteDeSupabase(id);
            if (eliminado) {
                await cargarClientesDesdeSupabase();
            }
        }

        function cerrarModal() {
            document.getElementById('cliente-modal').style.display = 'none';
        }

        document.getElementById('cliente-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                nombre: document.getElementById('nombre').value,
                cargo: document.getElementById('cargo').value,
                empresa: document.getElementById('empresa').value,
                email: document.getElementById('email').value,
                telefono: document.getElementById('telefono').value,
                direccion: document.getElementById('direccion').value,
                lat: parseFloat(document.getElementById('latitud').value) || 40.0,
                lng: parseFloat(document.getElementById('longitud').value) || -4.0,
                segmento: document.getElementById('segmento').value,
                volumen: parseInt(document.getElementById('volumen').value) || 0,
                notas: document.getElementById('notas').value
            };

            if (clienteEditando) {
                const actualizado = await actualizarClienteEnSupabase(clienteEditando.id, formData);
                if (actualizado) {
                    await cargarClientesDesdeSupabase();
                }
            } else {
                const guardado = await guardarClienteEnSupabase(formData);
                if (guardado) {
                    await cargarClientesDesdeSupabase();
                }
            }

            cerrarModal();
        });

        // ====================================================================
        // FUNCIONES EXPORTACI√ìN
        // ====================================================================

        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(20);
            doc.text('NATURPELLET - Informe Ejecutivo Expansi√≥n', 20, 20);

            doc.setFontSize(12);
            doc.text('Plan de Expansi√≥n Comercial 2025', 20, 30);
            doc.text('Fecha: ' + new Date().toLocaleDateString('es-ES'), 20, 40);

            doc.setFontSize(14);
            doc.text('Resumen Ejecutivo:', 20, 55);
            doc.setFontSize(10);
            doc.text(`Total Clientes Potenciales: ${clientes.length}`, 20, 65);
            doc.text(`Volumen Total: ${clientes.reduce((sum, c) => sum + c.volumen, 0).toLocaleString()} ton/a√±o`, 20, 75);
            doc.text(`Ingresos Potenciales: ${(clientes.reduce((sum, c) => sum + c.volumen, 0) * 300 / 1000000).toFixed(2)}M‚Ç¨`, 20, 85);

            let y = 100;
            doc.setFontSize(12);
            doc.text('Clientes Identificados:', 20, y);
            y += 10;

            doc.setFontSize(8);
            clientes.forEach((cliente, index) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }

                doc.text(`${index + 1}. ${cliente.empresa}`, 20, y);
                y += 8;
                doc.text(`   Contacto: ${cliente.nombre} (${cliente.cargo})`, 20, y);
                y += 6;
                doc.text(`   Email: ${cliente.email} | Tel: ${cliente.telefono}`, 20, y);
                y += 6;
                doc.text(`   Segmento: ${cliente.segmento} | Volumen: ${cliente.volumen} ton/a√±o`, 20, y);
                y += 6;
                doc.text(`   Direcci√≥n: ${cliente.direccion}`, 20, y);
                y += 10;
            });

            doc.save('naturpellet-clientes-supabase.pdf');
        }

        function exportarCSV() {
            const headers = ['ID', 'Nombre', 'Cargo', 'Empresa', 'Email', 'Tel√©fono', 'Direcci√≥n', 'Segmento', 'Volumen (ton/a√±o)', 'Latitud', 'Longitud', 'Notas'];

            let csv = headers.join(',') + '\n';

            clientes.forEach(cliente => {
                const row = [
                    cliente.id,
                    `"${cliente.nombre}"`,
                    `"${cliente.cargo}"`,
                    `"${cliente.empresa}"`,
                    cliente.email,
                    cliente.telefono,
                    `"${cliente.direccion}"`,
                    `"${cliente.segmento}"`,
                    cliente.volumen,
                    cliente.lat,
                    cliente.lng,
                    `"${cliente.notas}"`
                ];
                csv += row.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'naturpellet-clientes-supabase.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // ====================================================================
        // INICIALIZACI√ìN
        // ====================================================================

        document.addEventListener('DOMContentLoaded', function() {
            inicializarMapa();
        });

        window.onclick = function(event) {
            const modal = document.getElementById('cliente-modal');
            if (event.target === modal) {
                cerrarModal();
            }
        }
    </script>
</body>
</html>


